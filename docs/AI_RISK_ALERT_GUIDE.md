# 🚨 AI機能③: AIリスクアラートシステム - 使い方ガイド

## 📋 目次

1. [概要](#概要)
2. [主な機能](#主な機能)
3. [使い方](#使い方)
4. [リスク検出ロジック](#リスク検出ロジック)
5. [リスクの重要度レベル](#リスクの重要度レベル)
6. [API設定](#api設定)
7. [よくある質問](#よくある質問)

---

## 概要

**AIリスクアラートシステム**は、不動産売買決済における重要な期限や未完了タスクを自動的に検出し、AIが状況を分析して具体的な警告メッセージと対応策を生成する機能です。

### ✨ 何ができる？

- 📅 **自動期限チェック**: ダッシュボード表示時に全案件の期限を自動チェック
- 🎯 **優先度判定**: 融資特約期限など重要な期限を優先的に検出
- 🤖 **AI分析**: Google Gemini APIが状況を分析し、具体的な警告を生成
- 💡 **アクション提案**: AIが次に取るべき具体的な行動を提案
- 🎨 **視覚的表示**: 重要度に応じた色分けと、該当案件カードへのバッジ表示

---

## 主な機能

### 1. 自動リスクチェック

ダッシュボードを開くと、自動的に全案件をスキャンしてリスクを検出します。

**検出対象**:
- ✅ 融資特約期限（最優先）
- ✅ 決済予定日
- ✅ 期限切れタスク
- ✅ 3日以内の緊急タスク

### 2. AI生成の警告メッセージ

AIが各リスクに対して以下を生成します:

```
例：
【警告】A様邸: 融資特約期限が明日です。至急、C銀行 E様に状況を確認してください！

説明：
本案件の融資特約期限（2025-01-15）が明日に迫っています。
期限までに融資承認が得られない場合、契約解除のリスクがあります。
至急、金融機関に融資審査の進捗を確認し、必要な書類が全て提出されているか確認してください。

次のアクション：
1. C銀行のE様に電話で融資審査状況を確認
2. 売主側に融資特約期限の状況を報告
3. 必要に応じて期限延長の協議を開始
```

### 3. リスクバッジ表示

該当する案件カードに重要度に応じたバッジが表示されます:

- 🔴 **緊急**: 期限当日または期限切れ
- 🟠 **重要**: 1-2日以内
- 🟡 **注意**: 3日以内
- 🔵 **確認**: 軽微なリスク

---

## 使い方

### ステップ1: 自動チェック

1. **ダッシュボードを開く**
   - システムが自動的に全案件をチェック

2. **リスクがある場合**
   - ダッシュボード上部に警告カードが表示されます
   - 統計エリアに「リスク検出」カードが表示されます（赤色、パルス効果）
   - 該当する案件カードにバッジが表示されます

### ステップ2: 手動チェック

ダッシュボード右上の **「リスクチェック」** ボタンをクリックすると、いつでも最新の状況でリスクチェックを実行できます。

### ステップ3: アラートの確認

各警告カードには以下の情報が表示されます:

1. **重要度ラベル** (緊急/重要/注意/確認)
2. **AI生成の警告メッセージ** (状況の要約)
3. **詳細説明** (リスクの背景と影響)
4. **次のアクション** (具体的な対応策のリスト)
5. **案件情報** (案件名、決済日)

### ステップ4: アクションの実行

1. 「次のアクション」リストを確認
2. 必要な対応を実行
3. 完了したらアラートの「✕」ボタンで閉じる
4. または「案件を表示」ボタンで詳細画面へ移動

### ステップ5: 該当案件の確認

リスクバッジが表示されている案件カードをクリックすると、詳細画面で具体的なタスクを確認・更新できます。

---

## リスク検出ロジック

### 1. 融資特約期限リスク

**条件**:
- `loan_special_clause_deadline` が設定されている
- 期限まで3日以内
- 案件ステータスが「決済完了」ではない

**重要度**:
- **critical**: 期限切れ（0日未満）
- **high**: 当日〜明日（0-1日）
- **medium**: 2-3日以内

**理由**: 融資特約期限は契約解除の重要な判断日のため最優先

### 2. 決済予定日リスク

**条件**:
- `settlement_date` が設定されている
- 決済日まで3日以内
- 案件ステータスが「決済完了」ではない

**重要度**:
- **critical**: 期限切れ
- **high**: 当日〜明日
- **medium**: 2-3日以内

### 3. 期限切れタスク

**条件**:
- タスクの `due_date` が過去
- タスクが未完了（`is_completed = false`）

**重要度**:
- **critical**: 期限切れ日数に応じて判定

### 4. 緊急タスク

**条件**:
- タスクの `due_date` が3日以内
- タスクが未完了

**重要度**:
- **high**: 当日〜明日
- **medium**: 2-3日以内

---

## リスクの重要度レベル

### 🔴 Critical (緊急)

```css
背景: 赤グラデーション (#fc8181 → #e53e3e)
```

**意味**: 即座に対応が必要な緊急事態

**例**:
- 融資特約期限が過ぎている
- 決済予定日が過ぎている
- 重要タスクが大幅に遅延

### 🟠 High (重要)

```css
背景: オレンジグラデーション (#f6ad55 → #ed8936)
```

**意味**: 早急な対応が必要

**例**:
- 融資特約期限が明日
- 決済予定日が明日
- 重要タスクの期限が明日

### 🟡 Medium (注意)

```css
背景: 黄色グラデーション (#f6e05e → #ecc94b)
```

**意味**: 注意が必要、計画的に対応

**例**:
- 期限が2-3日以内
- 中程度のタスクが未完了

### 🔵 Low (確認)

```css
背景: 青グラデーション (#63b3ed → #4299e1)
```

**意味**: 念のため確認が必要

**例**:
- 軽微な遅延
- 優先度の低いタスクの期限

---

## API設定

### 必要な環境変数

```bash
# backend/.env
GEMINI_API_KEY=your_actual_gemini_api_key_here
```

### APIキーの取得方法

1. [Google AI Studio](https://aistudio.google.com/) にアクセス
2. Googleアカウントでログイン
3. 「Get API Key」をクリック
4. 新しいAPIキーを作成
5. `.env` ファイルに設定

### API使用量の目安

**1回のリスクチェックで**:
- 検出されたリスクごとに1回のAPI呼び出し
- 平均的な入力トークン: 500-800 tokens
- 平均的な出力トークン: 300-500 tokens

**料金例** (Gemini 1.5 Pro):
- 入力: $0.00125 / 1K tokens
- 出力: $0.005 / 1K tokens
- 1回のリスク分析: 約 $0.001-0.003 (0.1-0.3円)

---

## よくある質問

### Q1: リスクチェックは何回実行できますか？

**A**: 手動チェックボタンで何度でも実行できます。ただし、API使用量には注意してください。

### Q2: リスクアラートを無視するとどうなりますか？

**A**: アラートは閉じることができますが、次回のリスクチェック時に再度検出されます。根本的な解決にはタスクを完了させるか、期限を更新する必要があります。

### Q3: APIキーを設定しないとどうなりますか？

**A**: 基本的なリスク検出は動作しますが、AI生成の詳細なメッセージやアクション提案は表示されません。デフォルトのメッセージが表示されます。

### Q4: リスクチェックが失敗した場合は？

**A**: エラーはコンソールに出力され、ユーザーには通知されません（バックグラウンド処理のため）。次回のチェック時に再試行されます。

### Q5: 複数のリスクがある案件の表示は？

**A**: 案件カードには最も重要度が高いリスクのバッジが1つ表示されます。括弧内に総リスク数が表示されます（例: 緊急 (3件)）。

### Q6: リスク検出の基準日は？

**A**: チェック実行時の現在日時が基準です。時間帯によって「3日以内」の判定が変わる場合があります。

### Q7: 決済完了後の案件は？

**A**: ステータスが「決済完了」の案件はリスクチェックの対象外です。

---

## 技術詳細

### バックエンド実装

**ファイル**: `backend/src/services/riskAnalysisService.js`

**主要関数**:
```javascript
analyzeRisks(projects, tasksMap, contactsMap)
// 全案件をスキャンしてリスクを検出

generateAllRiskAlerts(risks, projects, tasksMap, contactsMap)
// 検出されたリスクに対してAIで警告を生成
```

**API エンドポイント**: `backend/src/routes/riskRoutes.js`
- `POST /api/risk/check` - 基本的なリスク検出（AI不使用）
- `POST /api/risk/check-with-ai` - AI分析込みのリスク検出
- `GET /api/risk/health` - ヘルスチェック

### フロントエンド実装

**コンポーネント**: `frontend/src/components/RiskAlerts.jsx`
- リスクアラートカードの表示
- 重要度に応じたスタイリング
- 閉じる・詳細表示機能

**統合**: `frontend/src/pages/Dashboard.jsx`
- `useEffect` で自動リスクチェック
- 手動チェックボタン
- 案件カードへのバッジ表示

---

## まとめ

AIリスクアラートシステムは、不動産決済業務における重要な期限管理をサポートします:

✅ **自動化**: 手動チェック不要、常に最新の状況を把握  
✅ **AI活用**: 状況に応じた具体的な警告とアクション提案  
✅ **視覚化**: 色分けとバッジで一目でリスクを把握  
✅ **実用的**: すぐに行動に移せる具体的な提案

このシステムを活用して、リスクを早期に発見し、スムーズな決済業務を実現してください！

---

**作成日**: 2025-11-12  
**バージョン**: 1.0.0  
**関連ドキュメント**:
- [AI_OCR_GUIDE.md](./AI_OCR_GUIDE.md) - AI契約書OCR機能
- [AI_EMAIL_GUIDE.md](./AI_EMAIL_GUIDE.md) - AIメール生成機能
- [README.md](../README.md) - システム全体のドキュメント
