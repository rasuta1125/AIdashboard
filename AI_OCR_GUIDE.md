# AI機能① 契約書AI-OCR 使用ガイド

## 📖 概要

売買契約書のPDFファイルをアップロードすると、Gemini AIが自動で重要情報を抽出し、案件詳細フォームに自動入力する機能です。

## ✨ 機能詳細

### 自動抽出される情報

1. **契約日** (contract_date)
2. **決済日/引渡日** (settlement_date)
3. **売買代金** (property_price)
4. **手付金** (deposit_amount)
5. **融資特約期限** (loan_special_clause_deadline)

### 対応ファイル形式

- **ファイル形式**: PDF のみ
- **最大サイズ**: 10MB
- **推奨**: テキスト検索可能なPDF（スキャンPDFも対応可能）

## 🚀 使用方法

### ステップ1: Gemini APIキーの取得

1. [Google AI Studio](https://makersuite.google.com/app/apikey) にアクセス
2. Googleアカウントでログイン
3. "Create API Key" または "Get API Key" をクリック
4. 生成されたAPIキーをコピー

### ステップ2: APIキーの設定

バックエンドの `.env` ファイルを編集：

```bash
cd backend
nano .env  # またはお好みのエディタ
```

以下の行を編集：

```env
GEMINI_API_KEY=your_actual_gemini_api_key_here
```

### ステップ3: サーバーの起動

#### バックエンド起動

```bash
cd backend
npm start
```

サーバーが起動すると以下のように表示されます：

```
==================================================
🚀 不動産売買決済管理システム - Backend API
==================================================
📍 Server: http://localhost:3001
🌍 Environment: development
🤖 Gemini API: ✅ 設定済み
==================================================
```

#### フロントエンド起動

別のターミナルで：

```bash
cd frontend
npm run dev
```

### ステップ4: AI-OCR機能の使用

1. **ブラウザでフロントエンドを開く**
   - http://localhost:5173 にアクセス

2. **案件を選択**
   - ダッシュボードから任意の案件カードをクリック

3. **AI-OCRボタンをクリック**
   - 案件詳細画面の「📋 案件基本情報」セクションにある
   - 紫色のグラデーションボタン「✨ AI-OCR」をクリック

4. **PDFファイルを選択**
   - ファイル選択ダイアログが開きます
   - 売買契約書のPDFを選択

5. **自動処理**
   - ボタンが「処理中...」に変わります
   - 完了すると「契約書情報を自動入力しました！」と表示されます
   - フォームに抽出されたデータが自動入力されます

6. **確認と編集**
   - 抽出されたデータを確認
   - 必要に応じて「編集」ボタンで修正

## 🎯 使用例

### 入力データ例

契約書に以下の情報が記載されている場合：

```
不動産売買契約書

契約日: 令和7年11月1日
物件引渡日: 令和7年12月15日
売買代金: 金45,000,000円
手付金: 金4,500,000円
融資利用の特約期限: 令和7年11月22日
```

### 出力結果例

抽出されるJSON：

```json
{
  "contract_date": "2025-11-01",
  "settlement_date": "2025-12-15",
  "property_price": 45000000,
  "deposit_amount": 4500000,
  "loan_special_clause_deadline": "2025-11-22"
}
```

フォームに自動入力：
- **契約日**: 2025年11月01日 (金)
- **決済予定日**: 2025年12月15日 (日)
- **売買代金**: ¥45,000,000
- **手付金額**: ¥4,500,000
- **融資特約期限**: 2025年11月22日 (金)

## 🔧 トラブルシューティング

### 問題1: APIキーエラー

**症状:**
```
エラー: Gemini API key not configured
```

**解決方法:**
1. `.env` ファイルの `GEMINI_API_KEY` を確認
2. APIキーが正しく設定されているか確認
3. バックエンドサーバーを再起動

### 問題2: ファイルアップロードエラー

**症状:**
```
ファイルサイズが大きすぎます（最大10MB）
```

**解決方法:**
- PDFファイルのサイズを確認
- 10MB以下に圧縮するか、別のファイルを使用

### 問題3: 情報が抽出されない

**症状:**
- すべてのフィールドが `null`
- 一部の情報のみ抽出される

**考えられる原因と対策:**

1. **PDFがスキャン画像のみ**
   - Geminiはスキャンされた画像からもOCR可能ですが、精度が低下する可能性があります
   - テキスト検索可能なPDFを使用することを推奨

2. **契約書の形式が標準的でない**
   - Gemini AIは日本語の契約書に対応していますが、特殊な形式の場合、抽出できない場合があります
   - 手動で入力することをお勧めします

3. **情報の記載位置が特殊**
   - 契約書によっては、標準的な位置に情報が記載されていない場合があります
   - プロンプトのカスタマイズが必要な場合があります

### 問題4: CORS エラー

**症状:**
```
Access to fetch has been blocked by CORS policy
```

**解決方法:**
1. バックエンドの `.env` で `FRONTEND_URL` を確認
2. フロントエンドの `.env` で `VITE_API_BASE_URL` を確認
3. 両サーバーを再起動

## 📊 API仕様

### エンドポイント

```
POST /api/ocr/contract
```

### リクエスト

- **Content-Type**: `multipart/form-data`
- **Body**: 
  - `contract` (File): PDFファイル

### レスポンス

#### 成功時 (200 OK)

```json
{
  "success": true,
  "message": "契約書情報を正常に抽出しました",
  "data": {
    "contract_date": "2025-11-01",
    "settlement_date": "2025-12-15",
    "property_price": 45000000,
    "deposit_amount": 4500000,
    "loan_special_clause_deadline": "2025-11-22"
  },
  "metadata": {
    "originalFilename": "contract.pdf",
    "fileSize": 2048000,
    "processedAt": "2025-11-12T08:00:00.000Z"
  }
}
```

#### エラー時 (400/500)

```json
{
  "success": false,
  "error": "エラーメッセージ"
}
```

## 🔐 セキュリティ

### ファイル保護

- アップロードされたファイルは処理後、**自動的に削除**されます
- サーバーに永続的に保存されることはありません

### データ保護

- 抽出されたデータは一時的にメモリ内で処理されます
- データベースへの保存は別途実装が必要です（現在は未実装）

### APIキー管理

- APIキーは `.env` ファイルで管理
- `.gitignore` に追加済みで、Gitにコミットされません
- 本番環境では環境変数として設定することを推奨

## 💡 Tips

### より正確な抽出のために

1. **高品質なPDFを使用**
   - スキャンではなく、デジタル生成されたPDFが最適
   - 300dpi以上の解像度を推奨

2. **標準的な契約書フォーマット**
   - 一般的な不動産売買契約書のフォーマットに従っているものが最適

3. **テキストが選択可能なPDF**
   - PDFリーダーでテキストが選択できるか確認

### バッチ処理

複数の契約書を処理したい場合：
- 現在は1ファイルずつの処理のみ対応
- 将来のバージョンで複数ファイル一括処理を実装予定

## 📈 今後の拡張予定

- [ ] 複数ファイルの一括処理
- [ ] 抽出結果のプレビュー機能
- [ ] カスタムフィールドの抽出設定
- [ ] OCR結果の履歴保存
- [ ] 抽出精度の向上（プロンプトエンジニアリング）
- [ ] 他の書類タイプへの対応（重要事項説明書など）

## 📞 サポート

問題が解決しない場合は、以下の情報を含めてお問い合わせください：

- エラーメッセージの全文
- 使用しているブラウザとバージョン
- サーバーログ（backend/logs）
- 契約書のサンプル（個人情報は削除してください）

---

**作成日**: 2025-11-12  
**バージョン**: 1.0.0  
**対応モデル**: Gemini 1.5 Pro
