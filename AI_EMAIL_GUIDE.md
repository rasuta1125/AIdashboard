# AI機能② 連絡メール自動生成 使用ガイド

## 📖 概要

案件情報とタスクの進捗状況に基づいて、関係者への連絡メールを自動生成する機能です。Gemini AIが案件のコンテキストを理解し、プロフェッショナルなビジネスメールを作成します。

## ✨ 機能詳細

### 自動生成される内容

- **件名**: 案件と状況に応じた適切な件名
- **本文**: 丁寧なビジネスメール形式
  - 挨拶文
  - 案件情報の説明
  - 現在の状況報告
  - 次のアクション
  - 締めくくり

### 利用されるコンテキスト情報

AIは以下の情報を自動的に分析してメールを生成します：

1. **案件名** (例: A様邸 戸建売買)
2. **買主名** (Contactsテーブルから自動取得)
3. **売主名** (存在する場合)
4. **決済予定日**
5. **売買代金**
6. **完了したタスク名** (タスク完了時)
7. **タスクの優先度**

## 🚀 使用方法

### 方法1: 関係者セクションからメール作成

#### ステップ1: 案件詳細画面を開く

1. ダッシュボードから案件をクリック
2. 案件詳細画面が表示される

#### ステップ2: メール作成ボタンをクリック

1. 「👥 関係者」セクションを探す
2. 青いグラデーションの「📧 メール作成」ボタンをクリック

#### ステップ3: AIがメールを生成

1. モーダルウィンドウが開く
2. 「AIがメールを生成しています...」と表示
3. 数秒で生成完了

#### ステップ4: メールを確認・編集

1. 生成された件名と本文を確認
2. 必要に応じて内容を編集
3. 編集可能なテキストフィールド

#### ステップ5: メールをコピー

以下の3つの方法でコピー可能：

1. **全文をコピー**: 右下の「全文をコピー」ボタン
2. **件名のみコピー**: 件名欄の右にあるコピーアイコン
3. **本文のみコピー**: 本文欄の右にあるコピーアイコン

#### ステップ6: メールクライアントに貼り付け

1. お使いのメールソフト（Gmail、Outlook等）を開く
2. 新規メール作成
3. コピーした内容を貼り付け
4. 送信

### 方法2: タスク完了時の自動提案

#### ステップ1: 重要タスクを完了

1. 案件詳細画面の「✓ タスクリスト」セクション
2. 優先度が「高」のタスクのチェックボックスをクリック

#### ステップ2: 確認ダイアログ

タスク完了後、以下の確認ダイアログが表示されます：

```
「融資承認の確認」が完了しました。
関係者へのメール文面を生成しますか？

[キャンセル] [OK]
```

#### ステップ3: OKをクリック

「OK」をクリックすると、自動的にメール生成が開始されます。

#### ステップ4: タスク専用のメール生成

AIが完了したタスクに応じて、適切な文面を生成します：

- **融資承認タスク** → 融資承認完了と次の手続きについて
- **司法書士連絡タスク** → 登記手続きの準備について
- **決済準備タスク** → 決済当日の流れについて
- **その他** → 一般的な進捗報告

## 🎯 生成例

### 例1: 融資承認完了時のメール

#### 入力コンテキスト
- 案件名: A様邸 戸建売買
- 買主: 山田太郎様
- タスク名: 融資承認の確認
- 決済予定日: 2025年12月15日

#### 生成されるメール

**件名:**
```
【重要】融資承認完了のご報告（A様邸 戸建売買）
```

**本文:**
```
山田太郎 様

いつもお世話になっております。
株式会社○○不動産の□□でございます。

この度は、A様邸 戸建売買の件でご連絡させていただきます。

融資承認の確認が完了いたしました。

つきましては、銀行との金銭消費貸借契約に進んでまいります。
契約日程につきましては、改めてご連絡させていただきます。

決済予定日は2025年12月15日を予定しております。

引き続き、円滑なお取引のためにサポートさせていただきます。
ご不明な点等ございましたら、お気軽にお問い合わせください。

今後ともどうぞよろしくお願い申し上げます。

--
株式会社○○不動産
□□ △△
```

### 例2: 一般的な進捗報告

#### 入力コンテキスト
- 案件名: Bマンション取引
- 買主: 鈴木花子様
- 売買代金: 32,000,000円
- 決済予定日: 2025年12月01日

#### 生成されるメール

**件名:**
```
【ご報告】案件進捗のお知らせ（Bマンション取引）
```

**本文:**
```
鈴木花子 様

お世話になっております。
株式会社○○不動産の□□でございます。

Bマンション取引の進捗についてご連絡させていただきます。

案件の進捗についてご連絡いたします。

物件価格: 32,000,000円
決済予定日: 2025年12月01日

引き続き、円滑なお取引のためにサポートさせていただきます。

何かご不明な点等ございましたら、お気軽にご連絡ください。

今後ともよろしくお願い申し上げます。

--
株式会社○○不動産
□□ △△
```

## 🎨 UIの特徴

### モーダルウィンドウ

- **美しいデザイン**: 白を基調とした清潔感のあるデザイン
- **グラデーションボタン**: 視覚的に魅力的な青のグラデーション
- **スムーズアニメーション**: フェードイン・スライドアップ効果
- **レスポンシブ対応**: モバイルでも快適に使用可能

### 編集機能

- **件名編集**: テキスト入力フィールドで自由に編集
- **本文編集**: 複数行テキストエリアで詳細な編集が可能
- **リアルタイム編集**: 変更がすぐに反映

### コピー機能

- **ワンクリックコピー**: ボタン一つでクリップボードにコピー
- **視覚的フィードバック**: コピー成功時にチェックマークを表示
- **2秒後に自動リセット**: アイコンが自動的にコピーマークに戻る

## 🔧 カスタマイズ

### メール文面のカスタマイズ

生成されたメールは自由に編集できます：

1. **件名の変更**
   - より具体的な件名に変更
   - 顧客名や案件名を追加

2. **本文の調整**
   - 挨拶文のカスタマイズ
   - 詳細情報の追加
   - 署名の変更

3. **フォーマット調整**
   - 改行の追加・削除
   - 箇条書きの追加

### 生成ロジックのカスタマイズ

バックエンドの`emailGenerationService.js`でプロンプトをカスタマイズ可能：

```javascript
// プロンプトの調整例
const prompt = `
あなたは不動産取引の営業担当者です。
以下の情報に基づいて、関係者への連絡メールを作成してください。

【カスタマイズ項目】
- 会社名: ○○不動産
- 担当者名: □□ △△
- 電話番号: 03-XXXX-XXXX

...
`;
```

## 📊 API仕様

### エンドポイント1: 汎用メール生成

```
POST /api/email/generate
```

#### リクエストボディ

```json
{
  "projectName": "A様邸 戸建売買",
  "buyerName": "山田太郎様",
  "sellerName": "田中一郎様",
  "settlementDate": "2025-12-15",
  "propertyPrice": 45000000,
  "situation": "案件の進捗についてご連絡いたします",
  "nextAction": "引き続き、円滑なお取引のためにサポートさせていただきます",
  "recipientRole": "買主"
}
```

#### レスポンス

```json
{
  "success": true,
  "message": "メールを正常に生成しました",
  "email": {
    "subject": "【重要】案件進捗のご報告",
    "body": "山田太郎 様\n\nいつもお世話になっております..."
  },
  "metadata": {
    "projectName": "A様邸 戸建売買",
    "generatedAt": "2025-11-12T08:30:00.000Z"
  }
}
```

### エンドポイント2: タスク完了メール生成

```
POST /api/email/task-completion
```

#### リクエストボディ

```json
{
  "projectName": "A様邸 戸建売買",
  "taskName": "融資承認の確認",
  "buyerName": "山田太郎様",
  "settlementDate": "2025-12-15",
  "recipientRole": "買主"
}
```

## 🐛 トラブルシューティング

### 問題1: メール生成に時間がかかる

**症状:**
- 生成に10秒以上かかる
- ローディング表示が長時間続く

**原因と対策:**

1. **Gemini APIのレート制限**
   - 無料プランでは1分あたり15リクエストまで
   - 有料プランへのアップグレードを検討

2. **ネットワーク遅延**
   - インターネット接続を確認
   - VPN使用時は切断を試す

### 問題2: メールの内容が適切でない

**症状:**
- 生成されたメールが状況に合わない
- 情報が不正確

**対策:**

1. **案件情報を確認**
   - 案件の基本情報が正しく入力されているか確認
   - 関係者情報が登録されているか確認

2. **手動で編集**
   - 生成されたメールを適切に編集
   - 必要な情報を追加

3. **再生成**
   - モーダルを閉じて、再度「メール作成」をクリック

### 問題3: コピーボタンが動作しない

**症状:**
- コピーボタンをクリックしても反応がない

**原因と対策:**

1. **ブラウザのクリップボード権限**
   - ブラウザがクリップボードへのアクセスを許可しているか確認
   - HTTPSで接続していることを確認（HTTPでは動作しない場合あり）

2. **手動コピー**
   - テキストを選択して Ctrl+C (Cmd+C) でコピー

### 問題4: モーダルが開かない

**症状:**
- メール作成ボタンをクリックしてもモーダルが表示されない

**対策:**

1. **JavaScriptエラーを確認**
   - ブラウザの開発者ツール（F12）でコンソールを確認
   - エラーメッセージがあれば報告

2. **ページをリロード**
   - ブラウザをリロード（Ctrl+R / Cmd+R）

## 💡 Tips

### より良いメールを生成するために

1. **完全な案件情報を登録**
   - すべてのフィールドを入力
   - 関係者情報を漏れなく登録

2. **適切なタイミングで使用**
   - タスク完了直後
   - 重要な進捗があったとき

3. **生成後に確認・編集**
   - AIが生成した内容を必ず確認
   - 顧客に合わせて文面を調整

### 時短テクニック

1. **テンプレートとして活用**
   - 一度生成したメールを保存
   - 次回から部分的に再利用

2. **複数案件で同時使用**
   - 複数の案件で同じタイミングでメール生成
   - 効率的に連絡業務を処理

## 📈 今後の拡張予定

- [ ] メールテンプレート機能
- [ ] メール送信履歴の保存
- [ ] 複数受信者への一斉メール生成
- [ ] メール送信機能の統合（SMTP連携）
- [ ] PDFとしてエクスポート
- [ ] メール予約送信機能

## 📞 サポート

問題が解決しない場合は、以下の情報を含めてお問い合わせください：

- 使用しているブラウザとバージョン
- エラーメッセージの全文
- 案件情報のスクリーンショット（個人情報は削除）
- 生成されたメールの内容（問題がある場合）

---

**作成日**: 2025-11-12  
**バージョン**: 1.0.0  
**対応モデル**: Gemini 1.5 Pro
